{% extends "restaurant/base.html" %}

{% block title %}Men√∫{% endblock %}

{% block content %}

<h1>Men√∫</h1>

{% for dish in dishes %}
    <h2>{{ dish.name }} (${{ dish.price }})</h2>

    {% for p in dish.presentations.all %}
        <button onclick="addToCart({{ p.id }})">
            {{ p.name }} (+${{ p.extra_price }})
        </button>
    {% endfor %}
{% endfor %}

<hr>

<h2>Carrito</h2>

<table border="1" cellpadding="5" cellspacing="0">
    <thead>
        <tr>
            <th>Platillo</th>
            <th>Presentaci√≥n</th>
            <th>Precio</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="cart-body"></tbody>
    <tfoot>
        <tr>
            <th colspan="4" style="text-align:right">TOTAL</th>
            <th id="cart-total">$0.00</th>
            <th></th>
        </tr>
    </tfoot>
</table>

<form method="POST" action="{% url 'save_sale' %}">
    {% csrf_token %}
    <button type="submit">üíæ Guardar venta</button>
</form>

{% if messages %}
    {% for message in messages %}
        <p style="color:green">{{ message }}</p>
    {% endfor %}
{% endif %}

<script>
const initialCart = {{ cart|safe }};

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function renderCart(cart) {
    const tbody = document.getElementById("cart-body");
    const totalEl = document.getElementById("cart-total");

    tbody.innerHTML = "";

    let total = 0;
    let hasItems = false;

    for (const key in cart) {
        hasItems = true;
        const item = cart[key];
        const subtotal = item.price * item.quantity;
        total += subtotal;

        tbody.innerHTML += `
            <tr>
                <td>${item.dish}</td>
                <td>${item.presentation}</td>
                <td>$${item.price.toFixed(2)}</td>
                <td>${item.quantity}</td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button onclick="removeFromCart(${key})">‚ùå</button>
                </td>
            </tr>
        `;
    }

    if (!hasItems) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6">Carrito vac√≠o</td>
            </tr>
        `;
        total = 0;
    }

    totalEl.innerText = `$${total.toFixed(2)}`;
}

function addToCart(presentationId) {
    fetch("{% url 'add_to_cart' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": getCSRFToken()
        },
        body: "presentation_id=" + presentationId
    })
    .then(res => res.json())
    .then(data => {
        renderCart(data.cart);
    });
}

function removeFromCart(presentationId) {
    fetch("{% url 'remove_from_cart' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": getCSRFToken()
        },
        body: "presentation_id=" + presentationId
    })
    .then(res => res.json())
    .then(data => {
        renderCart(data.cart);
    });
}

// üî• Render inicial
renderCart(initialCart);
</script>

{% endblock %}
